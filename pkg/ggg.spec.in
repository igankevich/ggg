Name:           @name@
Version:        @version@
Release:        1%{?dist}
Summary:        Groups of groups of groups NSS and PAM modules
License:        @license@
URL:            http://igankevich.com/
Source0:        @name@-%{version}.tar.xz

Requires: ggg-crypt @ggg_crypt_version@
Requires: guile22
Requires: sqlitex @sqlitex_version@
Requires: unistdx @unistdx_version@
Requires: zxcvbn-c

BuildRequires: gcc-c++
BuildRequires: gettext
BuildRequires: gtest-devel
BuildRequires: guile22-devel
BuildRequires: meson
BuildRequires: pam-devel
#BuildRequires: pam_wrapper
BuildRequires: pkg-config
BuildRequires: sqlitex-devel @sqlitex_version@
BuildRequires: unistdx-devel @unistdx_version@
BuildRequires: zxcvbn-c-devel

%description
NSS and PAM modules that support arbitrary nesting of users and groups

%global debug_package %{nil}

# Guile directories
%define guile %(pkg-config --variable=guile guile-2.2)
%define guild %(pkg-config --variable=guild guile-2.2)
%define guile_site_dir %(%{guile} -c '(display (%%site-dir))')
%define guile_site_ccache_dir %(%{guile} -c '(display (%%site-ccache-dir))')
%define guile_extension_dir %(%{guile} -c "(display (cdr (assoc 'extensiondir %%guile-build-info)))")

%prep
%autosetup

%build
%meson -Dwith_man=true
%meson_build

%install
%meson_install
# compile guile files
mkdir -p ${RPM_BUILD_ROOT}%{guile_site_ccache_dir}/ggg
cd ${RPM_BUILD_ROOT}%{guile_site_dir}/ggg
for orig in *; do
	file=$(basename -- "$orig")
	name="${file%%.*}"
	%{guild} compile \
		-o ${RPM_BUILD_ROOT}%{guile_site_ccache_dir}/ggg/${name}.go \
		${orig}
done

%check
%meson_test

%post -p /sbin/ldconfig

%postun -p /sbin/ldconfig

%files
%defattr(0755,root,root,0755)
%{_bindir}/ggg
%{_libdir}/libnss_ggg.so*
%{_libdir}/libggg-core.so*
%{_libdir}/security/pam_ggg.so
%{guile_extension_dir}/libggg-guile.so*
%defattr(0644,root,root,0755)
%{_datadir}/locale/ru/LC_MESSAGES/ggg.mo
%{_datadir}/locale/en/LC_MESSAGES/ggg.mo
%{_mandir}/man*/*ggg*
%{guile_site_dir}/ggg
%{guile_site_ccache_dir}/ggg

%changelog
* Sun Jun 16 2019 Ivan Gankevich <igankevich@ya.ru> 1.2.0-3
Guile.
* Sat Jul 7 2018 Ivan Gankevich <igankevich@ya.ru> 1.0.9-3
Install man pages.
* Mon Jun 4 2018 Ivan Gankevich <igankevich@ya.ru> 0.6.2-2
Update to the newest version.
* Tue Apr 10 2018 Ivan Gankevich <igankevich@ya.ru> 0.2-1
Update to the newest version.
* Thu Aug 31 2017 Ivan Gankevich <igankevich@ya.ru> 0.1-1
Packaged everything.
