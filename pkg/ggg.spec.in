Name:           @name@
Version:        @version@
Release:        1%{?dist}
Summary:        Groups of groups of groups NSS and PAM modules
License:        @license@
URL:            http://igankevich.com/
Source0:        @name@-%{version}.tar.xz

Requires: ggg-crypt @ggg_crypt_version@
Requires: guile
Requires: libacl
Requires: sqlitex @sqlitex_version@
Requires: unistdx @unistdx_version@
Requires: zxcvbn-c

BuildRequires: gcc-c++
BuildRequires: gettext
BuildRequires: gtest-devel
BuildRequires: guile-devel
BuildRequires: libacl-devel
BuildRequires: meson
BuildRequires: pam-devel
BuildRequires: pam_wrapper
BuildRequires: sqlitex-devel @sqlitex_version@
BuildRequires: unistdx-devel @unistdx_version@
BuildRequires: zxcvbn-c-devel

%description
NSS and PAM modules that support arbitrary nesting of users and groups

%global debug_package %{nil}

# Guile directories
%define guile_version 2.0
%define guile_site_dir %(guile -c '(display (%site-dir))')
%define guile_ccache_site_dir %(guile -c '(display (last (%load-compiled-path)))')

%prep
%autosetup

%build
%meson -Dwith_man=true
%meson_build

%install
%meson_install
# compile guile files
for file in %{guile_site_dir}/ggg/*; do
	name="${file##*/}"
	guild compile -o %{guile_ccache_site_dir}/ggg/${name}.go
done

%check
%meson_test

%post -p /sbin/ldconfig

%postun -p /sbin/ldconfig

%files
%defattr(0755,root,root,0755)
%{_bindir}/ggg
%{_libdir}/libnss_ggg.so*
%{_libdir}/libggg_core.so*
%{_libdir}/libggg_guile.so*
%{_libdir}/security/pam_ggg.so
%defattr(0644,root,root,0755)
%{_datadir}/locale/ru/LC_MESSAGES/ggg.mo
%{_datadir}/locale/en/LC_MESSAGES/ggg.mo
%{_mandir}/man*/*ggg*
%{guile_site_dir}/ggg
%{guile_ccache_site_dir}/ggg

%changelog
* Sun Jun 16 2019 Ivan Gankevich <igankevich@ya.ru> 1.2.0-3
Guile.
* Mon Jul 7 2019 Ivan Gankevich <igankevich@ya.ru> 1.0.9-3
Install man pages.
* Mon Jun 4 2018 Ivan Gankevich <igankevich@ya.ru> 0.6.2-2
Update to the newest version.
* Tue Apr 10 2018 Ivan Gankevich <igankevich@ya.ru> 0.2-1
Update to the newest version.
* Thu Aug 31 2017 Ivan Gankevich <igankevich@ya.ru> 0.1-1
Packaged everything.
